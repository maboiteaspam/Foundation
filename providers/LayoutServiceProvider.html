<!DOCTYPE html>

<html>
<head>
  <title>LayoutServiceProvider.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>LayoutServiceProvider.php</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">C</span>\<span class="hljs-title">Provider</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">FS</span>\<span class="hljs-title">KnownFs</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">FS</span>\<span class="hljs-title">KnownFsTagResolver</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">FS</span>\<span class="hljs-title">LocalFs</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">FS</span>\<span class="hljs-title">Registry</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">Layout</span>\<span class="hljs-title">Layout</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">Layout</span>\<span class="hljs-title">Responder</span>\<span class="hljs-title">LayoutResponder</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">Layout</span>\<span class="hljs-title">Responder</span>\<span class="hljs-title">TaggedLayoutResponder</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">Layout</span>\<span class="hljs-title">Misc</span>\<span class="hljs-title">LayoutSerializer</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">Layout</span>\<span class="hljs-title">Misc</span>\<span class="hljs-title">RequestTypeMatcher</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Env</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Context</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Helper</span>\<span class="hljs-title">CommonViewHelper</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Helper</span>\<span class="hljs-title">LayoutViewHelper</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Helper</span>\<span class="hljs-title">RoutingViewHelper</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Silex</span>\<span class="hljs-title">Application</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Silex</span>\<span class="hljs-title">ServiceProviderInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">C</span>\<span class="hljs-title">Watch</span>\<span class="hljs-title">WatchedRegistry</span>;

<span class="hljs-comment">/**
 * Class LayoutServiceProvider
 * provides core mechanism
 * to compose and render a view
 *
 * <span class="hljs-doctag">@package</span> C\Provider
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LayoutServiceProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServiceProviderInterface</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">(Application <span class="hljs-variable">$app</span>)</span>
    </span>{
        LocalFs::<span class="hljs-variable">$record</span> = <span class="hljs-variable">$app</span>[<span class="hljs-string">'debug'</span>];</pre></div>
        
      
        
        <p>provides a factory to create layout objects,
as Layout is the backbone which delimits both concerns
it is tightly linked to underlying modules
about http, translation and some more.
Use this factory to get an insitu Layout object,
in context of the current request treatment.</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.factory'</span>] = <span class="hljs-variable">$app</span>-&gt;protect(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> <span class="hljs-title">use</span><span class="hljs-params">(<span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-variable">$layout</span> = <span class="hljs-keyword">new</span> Layout();
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$app</span>[<span class="hljs-string">'debug'</span>]) <span class="hljs-variable">$layout</span>-&gt;enableDebug(<span class="hljs-keyword">true</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'dispatcher'</span>])) <span class="hljs-variable">$layout</span>-&gt;setDispatcher(<span class="hljs-variable">$app</span>[<span class="hljs-string">'dispatcher'</span>]);
            <span class="hljs-variable">$layout</span>-&gt;setContext(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.view'</span>]);
            <span class="hljs-variable">$layout</span>-&gt;setFS(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.fs'</span>]);


            <span class="hljs-variable">$requestMatcher</span> = <span class="hljs-keyword">new</span> RequestTypeMatcher();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'locale.manager'</span>])) {
                <span class="hljs-variable">$localMngr</span> = <span class="hljs-variable">$app</span>[<span class="hljs-string">'locale.manager'</span>];
                <span class="hljs-variable">$requestMatcher</span>-&gt;setLang(<span class="hljs-variable">$localMngr</span>-&gt;getLocale());
            }
            <span class="hljs-variable">$requestMatcher</span>-&gt;setDevice(<span class="hljs-string">'desktop'</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">"mobile_detect"</span>])) {
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$app</span>[<span class="hljs-string">"mobile_detect"</span>]-&gt;isTablet()) {
                    <span class="hljs-variable">$requestMatcher</span>-&gt;setDevice(<span class="hljs-string">'tablet'</span>);
                } <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$app</span>[<span class="hljs-string">"mobile_detect"</span>]-&gt;isMobile()) {
                    <span class="hljs-variable">$requestMatcher</span>-&gt;setDevice(<span class="hljs-string">'mobile'</span>);
                }
            }
            <span class="hljs-variable">$layout</span>-&gt;setRequestMatcher(<span class="hljs-variable">$requestMatcher</span>);

            <span class="hljs-variable">$layoutViewHelper</span> = <span class="hljs-keyword">new</span> LayoutViewHelper();
            <span class="hljs-variable">$layoutViewHelper</span>-&gt;setEnv(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env'</span>]);
            <span class="hljs-variable">$layoutViewHelper</span>-&gt;setLayout(<span class="hljs-variable">$layout</span>);
            <span class="hljs-variable">$layout</span>-&gt;context-&gt;helpers-&gt;append(<span class="hljs-variable">$layoutViewHelper</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-variable">$layout</span>;
        });</pre></div>
        
      
        
        <p>Defines the current layout object for the current request</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout'</span>] = <span class="hljs-variable">$app</span>-&gt;share(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> <span class="hljs-title">use</span><span class="hljs-params">(<span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.factory'</span>]();
        });</pre></div>
        
      
        
        <p>defines environmental configuration
to impact visual rendering of the views</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.charset'</span>] = <span class="hljs-string">'utf-8'</span>;
        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.date_format'</span>] = <span class="hljs-string">''</span>;
        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.timezone'</span>] = <span class="hljs-string">''</span>;
        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.number_format'</span>] = <span class="hljs-string">''</span>;
        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env'</span>] = <span class="hljs-variable">$app</span>-&gt;share(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Application <span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-variable">$env</span> = <span class="hljs-keyword">new</span> Env();
            <span class="hljs-variable">$env</span>-&gt;setCharset(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.charset'</span>]);
            <span class="hljs-variable">$env</span>-&gt;setDateFormat(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.date_format'</span>]);
            <span class="hljs-variable">$env</span>-&gt;setTimezone(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.timezone'</span>]);
            <span class="hljs-variable">$env</span>-&gt;setNumberFormat(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env.number_format'</span>]);
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$env</span>;
        });</pre></div>
        
      
        
        <p>defines the view context within what the views are rendered.
it provides the templates with the ability
of a dynamically enhanced $this object of helpers methods</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.view'</span>] = <span class="hljs-variable">$app</span>-&gt;share(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Context();
        });</pre></div>
        
      
        
        <p>register the common view helper
on the view context</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.view'</span>] = <span class="hljs-variable">$app</span>-&gt;share(
            <span class="hljs-variable">$app</span>-&gt;extend(<span class="hljs-string">"layout.view"</span>,
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Context <span class="hljs-variable">$view</span>, Application <span class="hljs-variable">$app</span>)</span> </span>{
                    <span class="hljs-variable">$view</span>-&gt;helpers-&gt;append(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.helper.common'</span>]);
                    <span class="hljs-keyword">return</span> <span class="hljs-variable">$view</span>;
                }
            )
        );</pre></div>
        
      
        
        <p>provides common view context helper
it provides translations, encoding, text helpers</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.helper.common'</span>] = <span class="hljs-variable">$app</span>-&gt;share(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Application <span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-variable">$commonHelper</span> = <span class="hljs-keyword">new</span> CommonViewHelper();
            <span class="hljs-variable">$commonHelper</span>-&gt;setEnv(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env'</span>]);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'translator'</span>])) {
                <span class="hljs-variable">$commonHelper</span>-&gt;setTranslator(<span class="hljs-variable">$app</span>[<span class="hljs-string">'translator'</span>]);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$commonHelper</span>;
        });</pre></div>
        
      
        
        <p>provides route view context helper
to generate urls against application defined routes</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.view'</span>] = <span class="hljs-variable">$app</span>-&gt;share(
            <span class="hljs-variable">$app</span>-&gt;extend(<span class="hljs-string">"layout.view"</span>,
                <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Context <span class="hljs-variable">$view</span>, Application <span class="hljs-variable">$app</span>)</span> </span>{
                    <span class="hljs-variable">$routingHelper</span> = <span class="hljs-keyword">new</span> RoutingViewHelper();
                    <span class="hljs-variable">$routingHelper</span>-&gt;setEnv(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.env'</span>]);
                    <span class="hljs-variable">$routingHelper</span>-&gt;setUrlGenerator(<span class="hljs-variable">$app</span>[<span class="hljs-string">"url_generator"</span>]);
                    <span class="hljs-variable">$view</span>-&gt;helpers-&gt;append(<span class="hljs-variable">$routingHelper</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-variable">$view</span>;
                }
            )
        );</pre></div>
        
      
        
        <p>provides the layout responder object
to wire the layout object
to the http implementation</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.responder'</span>] = <span class="hljs-variable">$app</span>-&gt;share(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Application <span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-variable">$responder</span> = <span class="hljs-keyword">new</span> LayoutResponder();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'httpcache.tagger'</span>])) {
                <span class="hljs-variable">$responder</span> = <span class="hljs-keyword">new</span> TaggedLayoutResponder();
                <span class="hljs-variable">$responder</span>-&gt;setTagger(<span class="hljs-variable">$app</span>[<span class="hljs-string">'httpcache.tagger'</span>]);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$responder</span>;
        });</pre></div>
        
      
        
        <p>the name of the cache to store
templates fs</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.cache_store_name'</span>]))
            <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.cache_store_name'</span>] = <span class="hljs-string">"layout-store"</span>;</pre></div>
        
      
        
        <p>declare a new templates FS,
to register the templates of the module</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.fs'</span>] = <span class="hljs-variable">$app</span>-&gt;share(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Application <span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-variable">$store</span> = <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.cache_store_name'</span>];
            <span class="hljs-variable">$cache</span> = <span class="hljs-variable">$app</span>[<span class="hljs-string">'cache.get'</span>](<span class="hljs-variable">$store</span>);

            <span class="hljs-variable">$registry</span> = <span class="hljs-keyword">new</span> Registry(<span class="hljs-variable">$store</span>, <span class="hljs-variable">$cache</span>, [
                <span class="hljs-string">'basePath'</span> =&gt; <span class="hljs-variable">$app</span>[<span class="hljs-string">'project.path'</span>]
            ]);
            <span class="hljs-variable">$registry</span>-&gt;restrictWithExtensions([
                <span class="hljs-string">'php'</span>,
            ]);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KnownFs(<span class="hljs-variable">$registry</span>);
        });</pre></div>
        
      
        
        <pre><code>   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'form.extensions'</span>])) {
</code></pre><p>@todo dig more about form framework…
           $app[‘form.extensions’] = $app-&gt;share($app-&gt;extend(‘form.extensions’, function ($extensions) use ($app) {
               $extensions[] = new CoreExtension();
               return $extensions;
           }));
       }</p>

        
          <div class='highlight'><pre>    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">(Application <span class="hljs-variable">$app</span>)</span>
    </span>{</pre></div>
        
      
        
        <p>register templates FS to the watcher system.
it will watch templates and triggers fs build.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'watchers.watched'</span>])) {
            <span class="hljs-variable">$app</span>[<span class="hljs-string">'watchers.watched'</span>] = <span class="hljs-variable">$app</span>-&gt;share(
                <span class="hljs-variable">$app</span>-&gt;extend(<span class="hljs-string">'watchers.watched'</span>,
                    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-variable">$watched</span>, Application <span class="hljs-variable">$app</span>)</span> </span>{
                        <span class="hljs-variable">$w</span> = <span class="hljs-keyword">new</span> WatchedRegistry();
                        <span class="hljs-variable">$w</span>-&gt;setRegistry(<span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.fs'</span>]-&gt;registry);
                        <span class="hljs-variable">$w</span>-&gt;setName(<span class="hljs-string">"layout.fs"</span>);
                        <span class="hljs-variable">$watched</span>[] = <span class="hljs-variable">$w</span>;
                        <span class="hljs-keyword">return</span> <span class="hljs-variable">$watched</span>;
                    }
                )
            );
        }</pre></div>
        
      
        
        <p>get ready to display a page</p>

        
          <div class='highlight'><pre>        <span class="hljs-variable">$app</span>-&gt;before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">(<span class="hljs-variable">$app</span>)</span> </span>{
            <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.fs'</span>]-&gt;registry-&gt;loadFromCache();
        });</pre></div>
        
      
        
        <p>register a new tag computer
to bind templates into the cache system</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$app</span>[<span class="hljs-string">'httpcache.tagger'</span>])) {
            <span class="hljs-variable">$fs</span> = <span class="hljs-variable">$app</span>[<span class="hljs-string">'layout.fs'</span>];
            <span class="hljs-variable">$tagger</span> = <span class="hljs-variable">$app</span>[<span class="hljs-string">'httpcache.tagger'</span>];
            <span class="hljs-comment">/* <span class="hljs-doctag">@var</span> $fs \C\FS\KnownFs */</span>
            <span class="hljs-comment">/* <span class="hljs-doctag">@var</span> $tagger \C\TagableResource\ResourceTagger */</span>
            <span class="hljs-variable">$tagger</span>-&gt;addTagComputer(<span class="hljs-string">'template'</span>, <span class="hljs-keyword">new</span> KnownFsTagResolver(<span class="hljs-variable">$fs</span>));
        }
    }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
